<html>
    
    <head>
        <title>{{ title }} - Arg Navigation</title>
        
		<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
		<script src="{{ url_for('static', filename='js/jquery-3.4.1.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/svg-pan-zoom.js') }}"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet"/>

		
    </head>
	<body>
    <header>
        <img src="{{url_for('static', filename='img/argnav.png')}}" />
	    <h1> {{ title }} </h1>
        
	</header>
    
	<div class="container">
	
		<div class="tableclass">
			
			{% for t in table %}
				{{ t|safe }}
			{% endfor %}
		</div>
        <div class="buttonclass"> 
            <button id="table_button" onclick="toggleButton()"><span id='btn_table_text'> &#8679; Centrality &#8679;</span></button>
        </div>
        
		<div class="canvasclass">
			{{ svg }}		
		</div>
	    <div class="annotation_buttonclass"> 
            <button id="annotation_button" onclick="toggleAnnButton()"><span id='btn_ann_text'>  &#8679; Annotation &#8679;</span></button>
        </div>
        
	
	<div class="annotationclass">
			<table id="annotationtable"></table>	
    </div>
	
    </div>
        
    <div id="dialog" title="Select Relation">
    <select id="schema" name="schema">
        <option value="RA">Default Inference (RA) </option>
        <option value="CA">Default Conflict (CA)</option>
        <option value="MA">Default Rephrase (MA)</option>
    </select>
    </div>
  
    </body>
	
			<script>
	window.onload=function(){
	//document.getElementsByClassName('dataframe')[0].addEventListener("click",function(e) {
	// e.target was the clicked element
	//console.log(e.currentTarget);
	//});
        
    $('#dialog').hide();
	//var table = document.getElementByID('annotationtable')[0];
    //console.log('got here');
	
	//if (table) {
	//	for (var i = 0; i < table.rows.length; i++) {
	//	table.rows[i].onclick = function() {
	//		var aifid= tableText(this);
	//		console.log(aifid);
	//		};
	//	}
	//}

	//function tableText(tableRow) {
	//	var aifid = tableRow.childNodes[1].innerHTML;
	//	return aifid;

	//}
	
	}
	
	</script>
    <script>
        
        //https://stackoverflow.com/questions/14949210/dynamically-update-a-table-using-javascript
        
        var dynamicTable = (function() {
    
    var _tableId, _table, 
        _fields, _headers, 
        _defaultText;
    
    /** Builds the row with columns from the specified names. 
     *  If the item parameter is specified, the memebers of the names array will be used as property names of the item; otherwise they will be directly parsed as text.
     */
    function _buildRowColumns(names, item) {
        var row = '<tr>';
        if (names && names.length > 0)
        {
            $.each(names, function(index, name) {
                var c = item ? item[name+''] : name;
                row += '<td>' + c + '</td>';
            });
        }
        row += '</tr>';
        return row;
    }
    
    /** Builds and sets the headers of the table. */
    function _setHeaders() {
        // if no headers specified, we will use the fields as headers.
        _headers = (_headers == null || _headers.length < 1) ? _fields : _headers; 
        var h = _buildRowColumns(_headers);
        if (_table.children('thead').length < 1) _table.prepend('<thead></thead>');
        _table.children('thead').html(h);
    }
    
    function _setNoItemsInfo() {
        if (_table.length < 1) return; //not configured.
        var colspan = _headers != null && _headers.length > 0 ? 
            'colspan="' + _headers.length + '"' : '';
        var content = '<tr class="no-items"><td ' + colspan + ' style="text-align:center">' + 
            _defaultText + '</td></tr>';
        if (_table.children('tbody').length > 0)
            _table.children('tbody').html(content);
        else _table.append('<tbody>' + content + '</tbody>');
    }
    
    function _removeNoItemsInfo() {
        var c = _table.children('tbody').children('tr');
        if (c.length == 1 && c.hasClass('no-items')) _table.children('tbody').empty();
    }
    
    return {
        /** Configres the dynamic table. */
        config: function(tableId, fields, headers, defaultText) {
            _tableId = tableId;
            _table = $('#' + tableId);
            _fields = fields || null;
            _headers = headers || null;
            _defaultText = defaultText || 'No items to list...';
            _setHeaders();
            _setNoItemsInfo();
            return this;
        },
        /** Loads the specified data to the table body. */
        load: function(data, append) {
            if (_table.length < 1) return; //not configured.
            _setHeaders();
            _removeNoItemsInfo();
            if (data && data.length > 0) {
                var rows = '';
                $.each(data, function(index, item) {
                    rows += _buildRowColumns(_fields, item);
                });
                var mthd = append ? 'append' : 'html';
                _table.children('tbody')[mthd](rows);
            }
            else {
                _setNoItemsInfo();
            }
            return this;
        },
        /** Clears the table body. */
        clear: function() {
            _setNoItemsInfo();
            return this;
        }
    };
}());
    </script>
    <script>
        //$("#table_button").click(function () {
       //     console.log('got here');
        //    $("#tableclass").animate({ width: 'toggle'});;
       //});
        

        
        d3.selectAll('.node')
    .on("click", handleMouseClick)
    .on("mouseover", handleMouseOver)
    .on("mouseout", handleMouseOut);
        
        var node_list = {{ child_nodes|tojson }};
        var edge_list = {{ child_edges|tojson }};
        var aif_nodes_list = {{ aif_nodes|tojson }};
        var svg_nodes_list = {{ svg_nodes|tojson }};
        var divergent_list = {{ div_nodes|tojson }};
        var snode_list = {{ s_nodes|tojson }};
        var from_annotation_list = [];
        var to_annotation_list = [];
        var from_text = [];
        var to_text = [];
        var schema_list = [];
        var annotation_counter = 0;
        var annotation_flag = false;
        var schema_type = '';
        
    var alert_box_flag = false;
        
        var dt = dynamicTable.config('annotationtable', 
                                 ['from', 'to', 'type'], 
                                 ['From', 'To', 'Type'], //set to null for field names instead of custom header names
                                 'No annotation to list...');
        
function addRowHandlers() {
    var rows = document.getElementById("annotationtable").rows;
    for (i = 0; i < rows.length; i++) {
        rows[i].onclick = function(){ return function(){
               var id = this.cells[0].innerHTML;
               console.log(id);
        };}(rows[i]);
    }
}
        
function double_click(element, aif_id){
    
    //console.log(element.text());
    //console.log(aif_id);
    //console.log(schema_list);
    
    if (!annotation_flag){
        //console.log('FROM');
        from_annotation_list.push(aif_id);
        from_text.push(element.text());
        annotation_flag = true;
        
    }else{
        //console.log('TO');
        to_annotation_list.push(aif_id);
        to_text.push(element.text());
        annotation_counter = annotation_counter + 1;
        // trigger node creation
        
        //console.log(json_data);
        $('#dialog').show();
        
        $('#dialog').dialog({
            buttons: { "OK": function() { $(this).dialog("close"); dialogue_btn_click(); populate_table();} } 
        });
        
        annotation_flag = false;
        
        
    }
    
    
}
function populate_table(){
    var json_data = get_JSON();
    dt.load(json_data, true);
        
    addRowHandlers();
}
        
function dialogue_btn_click(){
    //console.log($('#schema'));
    schema_type = $('#schema').val();
    schema_list.push(schema_type);
    return $('#schema').val();
}
        
function get_JSON(){
    var to_val = to_text[annotation_counter - 1];
    var from_val = from_text[annotation_counter - 1];
    var schema_val = schema_list[annotation_counter - 1];
    
    var json_data = [{ from: from_val, to: to_val, type: schema_val}];
    return json_data;
}
        
        
        
function handleMouseClick(d, i) {  // Add interactivity
    //d3.select(this).transform().translate(1000,0);
    //d3.select(this).style("x",0);
    //d3.select(this).style("y",0);
    //d3.select(this).transform.translate(0,0);
    //d3.select(this).style("visibility","hidden");
    //d3.select(this).attr("transform", "translate(0,-100)");
    var currEl = d3.select(this);
    var currNodeId = currEl.select('title').text();
    
    
    if (d3.event.shiftKey) {
        
        double_click(currEl, currNodeId);
        
        return;
    }
    
    //console.log(currEl.attr('nodeValue'));
    //console.log(currNodeId);
    //console.log(d3.select(this).attr('nodeValue'));
    //var edgeG = d3.selectAll(".edge[title='241534-&gt;241518']");
    
    var isClicked = d3.select(this).attr('nodeValue');
    
    //console.log(isClicked);
    
    var check_snode_flag = check_s_node(snode_list, currNodeId);
    //console.log('here');
    
    if(check_snode_flag){
        return;
    }
    
    var curr_svg_id = get_svg_id(currNodeId);
    var is_visible = check_visible(curr_svg_id);
    
    
    
    
    
    
    if(is_visible)
        {
            //var copy = '';
            
            //var copy1 = '';
            //console.log('got here 1');
            var sel_nodes = [];
            var sel_edges = [];
            getNodes(currNodeId, sel_nodes);
            getEdges(currNodeId, sel_edges);
            
            
            var sel_nodes_copy = $.extend(true,[],sel_nodes);;
            sel_nodes_copy.push(currNodeId);
            
            var div_flag = check_divergent_graph(divergent_list, sel_nodes_copy);
            
            if (alert_box_flag == false && div_flag == true){
                if(confirm('Sub-graph has divergent node, collapsing this sub-graph may lose information in other sub-graphs. Click ok to confirm and hide this message')){
                    alert_box_flag = true;
                }
                else{
                    alert_box_flag = false;
                    return;
                }
            }
            
            var all_nodes = [];
            var node_list_copy = $.extend(true,[],node_list);; 
            //var all_nodes = check_sub_graphs(node_list_copy, sel_nodes_copy);
            //console.log(sel_nodes);
            for (i = 0; i < sel_nodes.length; i++){
                
                node_id = sel_nodes[i];
                
                var check_div_flag = check_divergent_node(divergent_list, node_id);
                
                if(check_div_flag){
                    continue;
                }
                
                svg_id = get_svg_id(node_id);
                
                if(isClicked == 'true'){
                    show_node(svg_id);
                    show_table_row(svg_id);
                    currEl.attr('nodeValue', 'false');
                    
                }
                else{
                    //var inSubGraph = check_in_subgraph(node_id, all_nodes);
                    //if(!inSubGraph)
                    //    
                    
                    hide_node(svg_id); 
                    hide_table_row(svg_id);
                    //   }
                    
                    currEl.attr('nodeValue', 'true');
                }
                
            }
            if(currEl.attr('nodeValue') == 'true' ){
                var copy = currEl.clone(true).attr("transform", "translate(-5,5)");
                copy.style("opacity",1);
                var copy1 = currEl.clone(true).attr("transform", "translate(-10,10)");
                copy1.style("opacity",1);
                currEl.raise().classed("active", true);
    }else{
                currElcp = currEl;
                var allEls = d3.selectAll('#' + currEl.attr('id')).nodes();
                //console.log(allEls[0]);
                //d3.selectAll('#' + currEl.attr('id') + '.node').remove();
                for(z = 0; z < allEls.length -1; z++){
                    //console.log(allEls[z].remove());
                    allEls[z].remove();
                }
                    //console.log(allEls.nodes());
                //console.log('code abobe');
            }
            
            hide_edges(sel_edges, isClicked);
        }
    else{
        console.log('Invisble Node');
    }
    
    
    
    
    
    
}
        
function check_s_node(snodes_list, aif_id){
    if(snodes_list.indexOf(parseInt(aif_id)) !== -1){
            return true;
        }else{
            return false;
        } 
}
        
function check_divergent_node(divergent_node_list, aif_id){
    if(divergent_node_list.indexOf(aif_id) !== -1){
            return true;
        }else{
            return false;
        } 
}
        
function check_divergent_graph(divergent_node_list, sub_graph_list){
    for (i = 0; i < sub_graph_list.length; i++){
        aif_id = sub_graph_list[i];
        
        if(divergent_node_list.indexOf(aif_id) !== -1){
            return true;
        } 
    }
    
    return false;
}
        
        
function check_sub_graphs(node_list_cp, anc_node_list){
    
    all_nodes_list = []
    
    for(i=0; i< anc_node_list.length; i++){
        var anc_node_id = anc_node_list[i];
        
        for (z =0; z < node_list_cp.length; z++){
            var node_id = node_list_cp[z][0];
        
            if(anc_node_id == node_id){
                node_list_cp[z][1] = [];
                break;
            }
            
        }
    }
    
    for(i=0; i<node_list_cp.length; i++){
        nodes = node_list_cp[i][1];
        all_nodes_list.push(...nodes);
    }
                
            
    
    return all_nodes_list;
    
    
    
        
    
}
        
        
function check_in_subgraph(node_id, all_list){
    
        
    if(all_list.indexOf(node_id) !== -1){
        return true;
    } else{
        return false;
    }
    
}
function hide_edges(sel_edges, isClicked){
    for(i=0; i< sel_edges.length; i++){
        var edge_title = sel_edges[i];
        //edge_title = edge_title.toString();
        var fromEdge = edge_title[0];
        var toEdge = edge_title[1];
        
        var edgeText = fromEdge + '->' + toEdge;
        
        if(edgeText == '->'){
            return;
        }
        
        //console.log(edgeText);
        
        var edgeG = '';
            
        edgeG =  d3.selectAll('.edge')
            .filter(function() {
                return d3.select(this).select('title').text() == edgeText; // filter by single attribute
            });
        
        var edge_ID = '';
        
        if(edgeG == ''){
            return;
        }
        //console.log(edgeG);
        try{
            edge_ID = edgeG.attr("id");
        }catch(e) {
            console.log(e);
        }
        
        
        if(isClicked == 'true'){
            show_node(edge_ID);
        }
        else{
            hide_node(edge_ID);
        }
        
    }
}
        
function check_visible(svg_id){
    svg_class_id = '#' + svg_id;
    var visibility = d3.select(svg_class_id).style("opacity");
    
    if (visibility < 0.1){
        return false;
    }
    
    return true;
}
        
function hide_table_row(svg_id){
    var table = document.getElementsByClassName('dataframe')[0];
    //console.log(table);
    
    var svg_class_id = '';
    svg_class_id = svg_id;
    
    if(svg_class_id == '')
        {
            return;
        }
    
    if (table) {
		for (var i = 0; i < table.rows.length; i++) {
            var textTable = tableText(table.rows[i]);
            if(svg_id == textTable){
                //console.log(table.rows[i]);
                table.rows[i].style.display = "none";
                break;
            }
            
		}
	}
    
}
        
function show_table_row(svg_id){
    var table = document.getElementsByClassName('dataframe')[0];
    //console.log(table);
    
    var svg_class_id = '';
    svg_class_id = svg_id;
    
    if(svg_class_id == '')
        {
            return;
        }
    
    if (table) {
		for (var i = 0; i < table.rows.length; i++) {
            var textTable = tableText(table.rows[i]);
            if(svg_id == textTable){
                //console.log(table.rows[i]);
                table.rows[i].style.display = "table-row";
                break;
            }
            
		}
	}
    
}
        
        


function tableText(tableRow) {
		var aifid = tableRow.childNodes[1].innerHTML;
		return aifid;

}
        
function hide_node(svg_id){
    
    svg_class_id = '#' + svg_id;
    
    
    if(svg_class_id == '#')
        {
            return;
        }
    
    
    
    var allEls = d3.selectAll(svg_class_id).nodes();
    
    if(allEls.length > 2)
        {
            
        
    
            for(z = 0; z < allEls.length -1; z++){
                console.log(allEls[z].remove());
                allEls[z].remove();
            }
        }
    
    //hide table row
    // get svg_id done
    // get table element
    
    
    
    d3.select(svg_class_id)
        .transition()
        .attr("transform", "translate(0,50)")
        .duration(500)
        .style("opacity",0);
    
}
        
function show_node(svg_id){
    svg_class_id = '#' + svg_id;

    if(svg_class_id == '#')
        {
            return;
        }
    d3.select(svg_class_id)
        .transition()
        .attr("transform", "translate(0,0)")
        .duration(500)
        .style("opacity",1);   
    
    
}
        
function get_svg_id(aif_id){
    for(i=0; i< aif_nodes_list.length; i++){
        aif_list_id = aif_nodes_list[i];
        svg_list_id = svg_nodes_list[i];
        if(aif_list_id == aif_id)
            {
                return svg_list_id;
            }
    }
    return '';
}

function handleMouseOver(d, i) {  // Add interactivity

            // Use D3 to select element, change color and size
    
    
    var visibility = d3.select(this).style("opacity");
    
    if (visibility < 0.1){
        d3.select(this).style("cursor", "default");
        d3.select(this).style("opacity",0);
    }else{
        d3.select(this).style("cursor", "cell");
        d3.select(this).style("opacity",0.3);
    }
    
    //x = bbox.x
    //y = bbox.y
    //wid = bbox.width
    //hei = bbox.height
    
    
            // Use D3 to select element, change color and size
    //d3.select(this).style("x",x);
    //d3.select(this).style("y",y);
    //d3.select(this).style("width",wid);
    //d3.select(this).style("height",hei);
    //d3.select(this).style("visibility","hidden");
}
        
function getNodes(nodeID, sel_n_list){
    for (i =0; i < node_list.length; i++){
        var node_id = node_list[i][0];
        
        
        if (node_id == nodeID){
            nodes = node_list[i][1];
            sel_n_list.push(...nodes);
            
            return sel_n_list;
        }
    }
    
}
        
function getEdges(nodeID, sel_e_list){
    for (i =0; i < edge_list.length; i++){
        var node_id = edge_list[i][0];
        
        
        if (node_id == nodeID){
            edges = edge_list[i][1];
            sel_e_list.push(...edges);
            
            return sel_e_list;
        }
    }
    
}

function handleMouseOut(d, i) {
            // Use D3 to select element, change color back to normal
            //d3.select(this).style({
            //  "opacity": 1
            //});
    var visibility = d3.select(this).style("opacity");
    
    if (visibility < 0.1){
        d3.select(this).style("cursor", "default");
        d3.select(this).style("opacity",0);
    }else{
        d3.select(this).style("cursor", "default");
        d3.select(this).style("opacity",1);
    }

    

}</script>
	<script src="{{ url_for('static', filename='js/panning.js') }}" defer></script>
    <script defer>
function toggleButton() {
  var x = document.getElementsByClassName("tableclass")[0];
  var canvas = document.getElementsByClassName("canvasclass")[0];
  var annclass = document.getElementsByClassName("annotationclass")[0];
    
  if (x.style.display === "none") {
      x.style.display = "block";
      
      if(annclass.style.display === "none"){
          canvas.style.width = "80%";
      }
      else{
          canvas.style.width = "80%";
      }
      
      
      $("#btn_table_text").html("&#8679; Centrality &#8679;");
  } else {
      $("#btn_table_text").html("&#8681; Centrality &#8681;");
      if(annclass.style.display === "none"){
          canvas.style.width = "100%";
      }
      else{
          canvas.style.width = "100%";
      }
      
    x.style.display = "none";
  }
}
    
    
function toggleAnnButton() {
  var x = document.getElementsByClassName("annotationclass")[0];
  var canvas = document.getElementsByClassName("canvasclass")[0];
  var tabclass = document.getElementsByClassName("tableclass")[0];
    
  if (x.style.display === "none") {
      x.style.display = "block";
      canvas.style.width = "60%";
      
      if(tabclass.style.display === "none"){
          canvas.style.width = "80%";
      }
      else{
          canvas.style.width = "60%";
      }
      
      
      $("#btn_ann_text").html("&#8681; Annotation &#8681;");
  } else {
      $("#btn_ann_text").html("&#8679; Annotation &#8679;");
      if(tabclass.style.display === "none"){
          canvas.style.width = "100%";
      }
      else{
          canvas.style.width = "80%";
      }
    x.style.display = "none";
  }
}

    
    </script>

    
</html>